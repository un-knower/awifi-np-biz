/** @Copyright 爱WiFi TOE项目组 @version v2017-8-15 19:43:31 */
var _GLOBAL_KEY="{@globalKey@}";var _GLOBAL_VALUE="{@globalValue@}";var _DEV_ID="{@devId@}";var _DEV_MAC="{@devMac@}";var _SSID="{@ssid@}";var _USER_IP="{@userIp@}";var _USER_MAC="{@userMac@}";var _USER_PHONE="{@userPhone@}";var _URL="{@url@}";var _LOGIN_TYPE="{@loginType@}";var _GW_ADDRESS="{@gwAddress@}";var _GW_PORT="{@gwPort@}";var _NAS_NAME="{@nasName@}";var _TOKEN="{@token@}";var _CUSTOMER_ID="{@customerId@}";var _CASCADE_LABEL="{@cascadeLabel@}";var _SITE_ID="{@siteId@}";var _SITE_PAGE_ID="{@sitePageId@}";var _SITE_NAME="{@siteName@}";var _PAGE_TYPE="{@pageType@}";var _NUM="{@num@}";var _DISCLAIMER="none";var hasEdit=0;var gobal_projectId="";var _debug=false,_console={log:function(){if(_debug){console.log(arguments)}}};function objectIsEmpty(obj){var name;for(name in obj){return false}return true}var ComponentClass=function(){var pageMap={page1:[],page2:[],page3:[],page4:[]};var componentJson=[];var entitylist=[];var pageDoing="",entityDoing="";pageMap["page2"].push({page_id:"page2",pageType:"2",num:"2",pageOperation:"add",pageId:"0"});pageMap["page4"].push({page_id:"page4",pageType:"4",num:"4",pageOperation:"add",pageId:"0"});function getComponentJsonItem(id){var result={};for(var i=0,len=componentJson.length;i<len;i++){var item=componentJson[i];if(item.id==id){result=item;break}}return result}function setComponentJsonItem(item){if(Object.keys(getComponentJsonItem(item.id)).length==0){componentJson.push(item)}}function getComponentJsons(){return componentJson}function setPageDoing(pageId){pageDoing=pageId;_console.log("设备当前页面pageDoing=>",pageDoing)}function getPageDoing(){_console.log("获取当前页面getPageDoing=>",pageDoing);return pageDoing}function setEntityDoing(comp_id){entityDoing=comp_id;_console.log("设置当前组件实体setEntityDoing=>",entityDoing)}function getEntityDoing(){_console.log("获取当前组件实体getEntityDoing=>",entityDoing);return entityDoing}function pageTypeName(page_type){if(page_type=="1"){return"引导"}else if(page_type=="2"){return"认证"}else if(page_type=="3"){return"过渡"}else{return"导航"}}function addPageId(){var page_id="page_"+(new Date).getTime().toString();return page_id}function addEntityId(){var comp_id="comp_"+(new Date).getTime().toString();return comp_id}function pageAdd(page_type,page_id,pageOperation,pageId){pageOperation=pageOperation||"add";pageId=pageId||"0";var page=pageMap["page"+page_type];page.push({page_id:page_id.toString(),pageType:page_type.toString(),num:1,pageOperation:pageOperation,pageId:pageId.toString()});var page_div=$("#page-type"+page_type),page_item_len=page_div.find(".page-item").size();var title=(page_type=="1"?"引导":"过渡")+"第"+(page_item_len+1)+"页";var _style=isSite()?"":'style="display:inline-block">';page_div.append('<div class="page-item">'+'<span><a class="page-title" href="javascript:;" data-page-id="'+page_id+'" data-page-type="'+page_type+'">'+title+"</a></span> "+'<a href="javascript:;" class="page-del" data-page-id="'+page_id+'" data-page-type="'+page_type+'" title="删除当前引导页" '+_style+"</a></div>");_console.log("添加页面结果add_page=>pagemap: ",pageMap)}function pageDel(page_type,page_id){var pages=pageMap["page"+page_type];for(var i=0,len=pages.length;i<len;i++){var item=pages[i];if(item.page_id==page_id){if(item.pageOperation=="edit"){item.pageOperation="remove"}else{var p=pages.splice(i,1)}break}}_console.log("删除页面结果pageDel=>pagemap: ",pageMap)}function getPageMap(pageType){pageType=pageType||"";return pageType?pageMap["page"+pageType]:pageMap}function addEntityData(data){var canChildEdit=!!data.canChildEdit?data.canChildEdit:"-1",canEdit=!!data.canEdit?data.canEdit:"-1",dataJson=data.dataJson?JSON.parse(data.dataJson):{},tpcId=!!data.id?data.id:"-1",componentId=data.componentId?data.componentId:"",componentOperation=data.componentOperation?data.componentOperation:"add",orderNo=!!data.orderNo?data.orderNo:"0";_console.log("添加组件实体addEntityData=>",data);var item={page_id:getPageDoing().toString(),comp_id:getEntityDoing().toString(),tpcId:tpcId.toString(),canEdit:canEdit.toString(),canChildEdit:canChildEdit.toString(),componentId:componentId.toString(),componentOperation:componentOperation,json:dataJson,orderNo:orderNo.toString()};entitylist.push(item);_console.log("添加组件实体结果addEntityData=>",entitylist)}function getEntityLists(){return entitylist}function getEntityData(comp_id){var comps=getEntityLists();var comp={};for(var i=0,len=comps.length;i<len;i++){var item=comps[i];if(item.comp_id==comp_id){comp=item;break}}_console.log("获取组件实体数据getEntityData=>",comp_id,comp);return comp}function getEntityState(compId){try{return window[compId].state}catch(e){console.log("[fault]getEntityState=>",compId);return{}}}function setEntityData(compId,key,value){var entity=getEntityData(compId);if(key=="componentOperation"&&entity[key]=="add"&&value=="remove"){delEntityData(compId)}else{entity[key]=value}}function delEntityData(compId){var entity=getEntityLists();for(var i=0,len=entity.length;i<len;i++){var item=entity[i];if(item&&item.comp_id==compId){entity.splice(i,1);break}}}function getPageEntityData(pageId,getState){getState=getState||false;var component=[];var compLists=getEntityLists();for(var i=0,len=compLists.length;i<len;i++){var item=compLists[i];if(item.page_id==pageId){if(getState){var compId=item.comp_id;item.json=getEntityState(compId)}component.push(item)}}component.sort(entitySort);return component}function editPageEntityList(pageId,isCreate){isCreate=isCreate||false;var entitys=getPageEntityData(pageId,true);_console.log("获取页面所有组件实体列表editPageEntityList=>",pageId,entitys);for(var i=0,len=entitys.length;i<len;i++){var item=entitys[i];if(isCreate){_console.log("第一次组件要执行setState");if(item.componentOperation!="remove"){createReactEntity(item)}}}return entitys}function getTemplateInfo(){var list=[];var pageMap=getPageMap();for(var page in pageMap){var num=1;var pages=pageMap[page];for(var i=0,len=pages.length;i<len;i++){var item=pages[i];var pageId=item.page_id;item.num=num.toString();var components=getPageEntityData(pageId,true);var hasComp=[];var hasCompRedirect=[];var hasAuth=[];var isPage13=/[13]/.test(item.pageType.toString());if(isPage13){var pageName=pageTypeName(item.pageType)+"第"+(i+1)+"页"}else{var pageName=pageTypeName(item.pageType)}for(var c=0,clen=components.length;c<clen;c++){var citem=components[c];var compJson=getComponentJsonItem(citem.componentId);if(citem.componentOperation!="remove"){hasComp.push(citem.componentId);if(item.pageType=="2"&&compJson.classify==2){hasAuth.push(citem.componentId)}if(isPage13&&item.pageOperation!="remove"&&compJson.classify==3){hasCompRedirect.push(citem.componentId)}}}if(hasComp.length==0){return{code:true,data:pageName+"不能为空"}}if(item.pageType==2&&hasAuth.length==0){return{code:true,data:"认证页必须含有认证组件"}}if(isPage13&&item.pageOperation!="remove"&&hasCompRedirect.length==0){return{code:true,data:pageName+"必须包含页面链接组件"}}item.component=components;list.push(item);num++}}_console.log("获取页面所有json数据getTemplateInfo=>",list);return{code:false,data:list}}function entityValidform(){var page2Entitys=getPageEntityData("page2",true);_console.log("验证页面数据entityValidform=>",page2Entitys);var hasAuth=1;for(var i=0,len=page2Entitys.length;i<len;i++){var item=page2Entitys[i];var compJson=getComponentJsonItem(item.componentId);if(item.componentOperation!="remove"&&compJson.classify==2){hasAuth=0;break}}return{code:hasAuth?true:false,message:hasAuth?"认证页必须含有认证组件":"认证页已含有认证组件"}}function getArgs(){var args={};var match=null;var search=location.search.substring(1);var reg=/(?:([^&]+)=([^&]+))/g;while((match=reg.exec(search))!==null){args[match[1]]=match[2]}return args}function layerCreate(showLoading){showLoading=showLoading||"show";var htm='<div id="layer_base" style="display:none;z-index:998;position:absolute;left:0;right:0;top:0;bottom:0;width:100%;height:100%;background-color:#ededed;background-color:rgba(0,0,0,0.3)">'+(showLoading==="show"?'<div style="position:absolute;z-index:999;left:50%;top:10%;width:42px;height:42px;margin-left:-21px;background-image:url(/images/loading.gif);">':"")+"</div></div>";$("body").append(htm);$("#layer_base").fadeIn()}function layerRemove(){var layer_base=$("#layer_base");layer_base.fadeOut(function(){layer_base.remove()})}function apiSave(){var templateInfo=getTemplateInfo();if(templateInfo.code){jDialog.alert("提示",templateInfo.data);return}if(templateId&&templateId>0){var url="/template/addAll";var resp_data={templateId:templateId,templateInfo:JSON.stringify(templateInfo.data)}}else if(siteId&&siteId>0){var url="/site/addAllSite";var resp_data={siteId:siteId,siteInfo:JSON.stringify(templateInfo.data)}}else if(siteDefaultId&&siteDefaultId>0){var url="/siteDefault/addAllDefaultSite";var resp_data={siteId:siteDefaultId,siteInfo:JSON.stringify(templateInfo.data)}}var btn_save=$(".btn-save");$.ajax({url:url,type:"post",data:resp_data,dataType:"json",beforeSend:function(){layerCreate();btn_save.attr("disabled","disabled")},success:function(resp){if(resp.result=="OK"){$("#page-type2 .page-title").click();thumbImgData(resp)}else{jDialog.alert("提示",resp.message)}},complete:function(){btn_save.removeAttr("disabled");layerRemove()}})}function pageEntityInit(data){var page_id=data.id,page_type=data.pageType;if(page_type=="1"||page_type=="3"){setPageDoing(page_id);pageAdd(page_type,page_id,"edit",page_id)}else{setPageDoing("page"+page_type);var page=pageMap["page"+page_type][0];page.pageOperation="edit";page.pageId=page_id.toString()}var componets=data.componets;for(var i=0,len=componets.length;i<len;i++){var item=componets[i];var comp_id=addEntityId();item["componentOperation"]="edit";setEntityDoing(comp_id);addEntityData(item);var componentJson=getComponentJsonItem(item.componentId);try{addHeader(componentJson)}catch(e){_console.log("[fault]pageEntityInit.addHeader=>",e);entityInitFault();return}if(page_type=="1"||page_type=="3"){var pageCompItems=getPageEntityData(page_id)}else{var pageCompItems=getPageEntityData("page"+page_type)}for(var j=0,jlen=pageCompItems.length;j<jlen;j++){var compItem=pageCompItems[j];try{createReactEntity(compItem,true)}catch(e){_console.log("[fault]pageEntityInit.createReactEntity=>",e);entityInitFault()}}}}function apiGetComponentData(){var _type="get";if(templateId&&templateId>0){var url="/template/pageList";var resp_data={templatePageId:templateId}}else if(siteId&&siteId>0){var url="/site/querySitePages";var resp_data={siteId:siteId};_type="post"}else if(siteDefaultId&&siteDefaultId>0){var url="/siteDefault/queryDefaultSitePage";var resp_data={siteId:siteDefaultId};_type="post"}$.ajax({url:url,type:_type,data:resp_data,dataType:"json",async:false,beforeSend:function(){layerCreate()},success:function(resp){_console.log("获取不同类型组件json apiGetComponentData=>",resp);var data=resp.data;gobal_projectId=resp.projectId;apiPageComponentListTodo(1);apiPageComponentListTodo(2);apiPageComponentListTodo(3);apiPageComponentListTodo(4);for(var i=0,len=data.length;i<len;i++){var item=data[i];pageEntityInit(item)}},complete:function(){var pageType1=$("#page-type1"),pageType1Page=pageType1.find(".page-title"),pageType2=$("#page-type2");if(pageType1Page.size()>0){pageType1Page.eq(0).click()}else{pageType2.find(".page-title").eq(0).click()}if(!isSite()){$(".page-del, .page-add").show()}layerRemove()}})}function hasFile(path){var re=new RegExp(path,"mg");var head=$("head").html();return re.test(head)}function addHeader(cpt_param){var head_files=[],_dt=(new Date).getTime(),path=cpt_param.componentPath,component_css=path+"/css/component.css?_t="+_dt,setting_css=path+"/css/setting.css?_t="+_dt,entity_js=path+"/script/Entity.js?_t="+_dt,setting_js=path+"/script/Setting.js?_t="+_dt;if(!objectIsEmpty(cpt_param)){if(!hasFile(component_css)){head_files.push('<link rel="stylesheet" type="text/css" href="'+component_css+'"/>')}if(!hasFile(setting_css)){head_files.push('<link rel="stylesheet" type="text/css" href="'+setting_css+'"/>')}if(!hasFile(entity_js)){head_files.push('<script src="'+entity_js+'"></script>')}if(!hasFile(setting_js)){head_files.push('<script src="'+setting_js+'"></script>')}$("head").append(head_files.join(""))}}function apiPageComponentListTodo(type){type=type||1;$.ajax({url:"/component/componentList",type:"get",data:{type:type,projectId:gobal_projectId},dataType:"json",async:false,success:function(resp){if(resp.result==="OK"){var data=resp.data;for(var i in data){var item=data[i];setComponentJsonItem(item)}}else{jDialog.alert("提示",resp.message)}}})}function apiPageComponentList(pageType,pageId){pageType=pageType||1;$.ajax({url:"/component/componentList",type:"get",data:{type:pageType,projectId:gobal_projectId},dataType:"json",async:false,success:function(resp){if(resp.result==="OK"){var data=resp.data,htm=[];for(var i in data){var item=data[i];htm.push('<li data-unique="'+item.canUnique+'" data-classify="'+item.classify+'" data-id="'+item.id+'" title="'+item.name+'">'+'<i style="background-image: url('+item.iconPath+')"></i>'+"<p>"+item.name+"</p>"+"</li>")}if(!isSite()){$("#comp-list").html(htm.join(""))}componentSortable(pageId)}else{jDialog.alert("提示",resp.message)}}})}function createReact(el,comp_id,cpt_param){var entity=getEntityData(comp_id);var entity_name=comp_id;var setting_name=entity_name+"s";var entity_del_icon=isSite()?"":'<div class="entity-del"></div>';var entity_htm='<div class="entity-cover"></div>'+entity_del_icon+'<div id="'+entity_name+'"></div>'+"<script type='text/javascript'>var "+entity_name+" = "+cpt_param.code+"(null, '"+entity_name+"').render()</script>";var setting_htm="<script>var "+setting_name+" = "+cpt_param.setCode+"("+entity_name+', "comp-set"); '+setting_name+".render();</script>";el.attr("data-cid",entity_name);el.siblings(".active").removeClass("active");el.addClass("active");el.css({"min-height":"auto"});el.html(entity_htm);$("#comp-set").html(setting_htm);compClass.setEntityData(comp_id,window[entity_name].state);propClass.init(entity)}function createReactEntity(data){var componentId=data.componentId;var compJson=getComponentJsonItem(data.componentId),comp_id=data.comp_id;if(!objectIsEmpty(compJson)){var entity=getEntityData(comp_id);var entity_del_icon=isSite()?"":'<div class="entity-del"></div>';var htm='<li data-unique="'+compJson.canUnique+'" data-classify="'+compJson.classify+'" data-id="'+componentId+'" data-code="'+compJson.code+'" data-set-code="'+compJson.setCode+'" '+' class="ui-draggable" data-cid="'+comp_id+'" style="min-height:auto">'+'<div class="entity-cover"></div>'+entity_del_icon+'<div id="'+comp_id+'"></div>'+'<script type="text/javascript">var '+comp_id+" = "+compJson.code+"("+JSON.stringify(data.json)+', "'+comp_id+'").render();</script></li>';_console.log("创建ReactJS createReactEntity=>",htm)}else{var fault_text=isSite()?"该组件未找到，请重新创建站点或删除该组件":"该组件未找到，请使用其它组件替代或删除该组件";var htm='<li data-id="'+componentId+'" data-cid="'+comp_id+'" style="min-height:inherit"><div class="entity-cover"></div><div class="entity-del"></div><p class="entity-fault">'+fault_text+"</p></div></li>"}$("#comp-main").append(htm)}var get_args=getArgs(),templateId=get_args["templateId"],siteId=get_args["siteId"],siteDefaultId=get_args["siteDefaultId"];_debug=get_args["debug"]?true:false;function isSite(){return!(!!templateId&&templateId>0)}function hideCompTip(){if(templateId&&templateId>0){$("#comp-title").show();$("#comp-tip").show()}}function init(){_console.log("是否站点页isSite()=>",isSite());if(isSite()){if(!!siteId&&siteId>0){var _siteId=siteId}else{var _siteId=siteDefaultId}$("#go-back").hide();$("#btn-preview").prop({href:"/site/forward?siteId="+_siteId,target:"_blank"})}else{$("#btn-preview").prop({href:"/template/forward?templateId="+templateId,target:"_blank"})}hideCompTip();if(!templateId&&!siteId&&!siteDefaultId&&location.pathname.indexOf("test.html")==-1){jDialog.alert("提示","非法操作");location.href="/"}else{setTimeout(function(){apiGetComponentData()},1e3)}}function entitySortableSort(){$("#comp-main li").each(function(k,v){var compId=$(v).attr("data-cid");var num=(k+1).toString();setEntityData(compId,"orderNo",num)})}function entitySort(a,b){var a_orderNo=parseFloat(a.orderNo);var b_orderNo=parseFloat(b.orderNo);if(a_orderNo>b_orderNo){return 1}else if(a_orderNo<b_orderNo){return-1}else{return 0}}function entityUnique(classify,id,action){action=action||"disable";if(action=="disable"){if(classify>1){if(classify==2){var comp_list_unique=$('#comp-list li[data-id="'+id+'"][data-unique="1"]')}else{var comp_list_unique=$('#comp-list li[data-classify="'+classify+'"][data-unique="1"]')}}else{var comp_list_unique=$('#comp-list li[data-id="'+id+'"][data-unique="1"]')}comp_list_unique.draggable("disable").css("cursor","not-allowed")}else{if(classify>1){var comp_list_unique=$('#comp-list li[data-classify="'+classify+'"][data-unique="1"]')}else{var comp_list_unique=$('#comp-list li[data-id="'+id+'"][data-unique="1"]')}comp_list_unique.draggable("enable").css("cursor","")}}function thumbImgData(result_data){result_data=result_data||{};html2canvas(document.getElementById("comp-main"),{background:"#fff",onrendered:function(canvas){var imgData=canvas.toDataURL("image/png");_console.log("canvas.toDataURL=>",imgData);if(isSite()){var url="/thumb/saveSiteThumb";var id=!!siteDefaultId?siteDefaultId:siteId}else{var url="thumb/saveTemplateThumb";var id=templateId}$.post(url,{imageStr:imgData,id:id},function(data){_console.log("thumbImgData=>",data);if(result_data.result=="OK"&&data.result=="OK"){jDialog.alert("提示",result_data.message,wclose);setTimeout("wclose()",2500)}else{jDialog.alert("提示",data.message,wclose)}},"json")}})}return{init:init,addHeader:addHeader,createReact:createReact,isSite:isSite,getPageDoing:getPageDoing,setPageDoing:setPageDoing,addPageId:addPageId,pageAdd:pageAdd,pageDel:pageDel,pageTypeName:pageTypeName,getPageMap:getPageMap,getPageEntityData:getPageEntityData,getComponentJsonItem:getComponentJsonItem,setComponentJsonItem:setComponentJsonItem,getComponentJson:getComponentJsons,getEntityDoing:getEntityDoing,setEntityDoing:setEntityDoing,addEntityId:addEntityId,getEntityLists:getEntityLists,addEntityData:addEntityData,getEntityData:getEntityData,setEntityData:setEntityData,editPageEntityList:editPageEntityList,entitySortableSort:entitySortableSort,entitySort:entitySort,entityUnique:entityUnique,layerCreate:layerCreate,layerRemove:layerRemove,getTemplateInfo:getTemplateInfo,apiPageComponentList:apiPageComponentList,apiSave:apiSave,thumbImgData:thumbImgData}};var PropertyClass=function(){var canEdit=$("#canEdit"),canChildEdit=$("#canChildEdit"),entity_checkbox=$("#entity-checkbox");function init(entity){canChildEdit.prop("checked",entity.canChildEdit=="1"?true:false);events();entity_checkbox.show()}function events(){canChildEdit.change(function(){var compId=compClass.getEntityDoing(),val=$(this).is(":checked")?"1":"-1";compClass.setEntityData(compId,"canChildEdit",val)})}return{init:init}};function wclose(){try{window.opener.location.reload();window.opener=null;window.close()}catch(e){location.reload();_console.log(e);return true}}var compClass=ComponentClass();compClass.init();var propClass=PropertyClass();function entityFault(el){var entity_htm_fault='<div class="entity-cover"></div><div class="entity-del-fault"></div><p class="entity-fault">该组件存在内部错误，请删除</p></div>';el.css({"min-height":"inherit"}).html(entity_htm_fault);$("#entity-checkbox").hide();$("#comp-set").empty()}function entityInitFault(){var entity_htm_fault='<li style="min-height:inherit"><div class="entity-cover"></div><div class="entity-del-fault"></div><p class="entity-fault">该组件存在内部错误，请删除</p></div></li>';$("#comp-main").append(entity_htm_fault)}function componentSortable(pageId){$("#comp-list li.ui-draggable-disabled").draggable("enable").css("cursor","");$("#comp-main").sortable({placeholder:"cpt-placeholder",containment:"#comp-main",forceHelperSize:true,revert:false,delay:150,stop:function(e,ui){var el=ui.item;var page_id=compClass.getPageDoing();if(!page_id){el.remove();jDialog.alert("提示","请先选择页面，再拖动所需组件");return}var comp_id=compClass.addEntityId();compClass.setEntityDoing(comp_id);if(el.attr("data-cid")){compClass.entitySortableSort();return}el.attr("class","ui-sortable-handle").removeAttr("style");var componentJson=compClass.getComponentJsonItem(el.attr("data-id"));try{compClass.addHeader(componentJson)}catch(e){_console.log("[fault]compClass.addHeader=>",e);entityFault(el);return}try{compClass.createReact(el,comp_id,componentJson)}catch(e){_console.log("[fault]compClass.createReact=>",e);entityFault(el);return}compClass.addEntityData({componentId:el.attr("data-id")});compClass.entitySortableSort();if(el.attr("data-unique")==1){compClass.entityUnique(componentJson.classify,componentJson.id)}window.hasEdit+=1;bindUnload()}});$("#comp-list li").draggable({connectToSortable:"#comp-main",scroll:false,revert:false,helper:function(e){return $(this).clone().prependTo("#comp-list")},cursor:"move",start:function(e,ui){ui.helper.addClass("cpt-dragging")}});var pageEntitys=compClass.editPageEntityList(pageId,false);for(var i=0,len=pageEntitys.length;i<len;i++){var item=pageEntitys[i];var compJson=compClass.getComponentJsonItem(item.componentId);if(compJson.canUnique==1&&item.componentOperation!="remove"){compClass.entityUnique(compJson.classify,compJson.id)}}}$(".entities").on("click","li .entity-cover",function(e){window.hasEdit+=1;bindUnload();var that=$(this).parents("li"),entity_name=that.attr("data-cid"),setting_name=entity_name+"s";that.addClass("active").siblings(".active").removeClass("active");if(that.find(".entity-del-fault").size()>0){$("#comp-set").empty();$("#entity-checkbox").hide();return}var componentJson=compClass.getComponentJsonItem(that.attr("data-id"));_console.log("编辑组件componentJson=>",componentJson);compClass.setEntityDoing(entity_name);var entity=compClass.getEntityData(entity_name);_console.log("编辑组件结果componentJson=>",entity);if(compClass.isSite()&&entity.canEdit=="1"){$("#comp-set").html('<div class="cannotEdit">没有编辑组件的权限</div>');$("#entity-checkbox").hide()}else{propClass.init(entity);try{$("#comp-set").html("<script>var "+setting_name+" = "+componentJson.setCode+"("+entity_name+', "comp-set"); '+setting_name+".render();</script>")}catch(e){_console.log("编辑组件实体SettingReact异常=>",e)}}});$(".entities").on("click","li .entity-del",function(e){window.hasEdit+=1;bindUnload();var el=$(this).parents("li"),cid=el.attr("data-cid"),sid=cid+"s";e.stopPropagation();el.remove();delete window[sid];$("#comp-set").empty();compClass.setEntityData(cid,"componentOperation","remove");var compJson=compClass.getComponentJsonItem(el.attr("data-id"));if(el.attr("data-unique")==1){compClass.entityUnique(compJson.classify,compJson.id,"enable")}$("#entity-checkbox").hide()});$(".entities").on("click","li .entity-del-fault",function(e){var el=$(this).parents("li");e.stopPropagation();el.remove()});$(".page-add").click(function(){var that=$(this),page_type=that.attr("data-page-type");var page_id=compClass.addPageId();compClass.pageAdd(page_type,page_id)});$(document).on("click",".page-del",function(){var that=$(this),page_id=that.attr("data-page-id"),page_type=that.attr("data-page-type"),page_item=that.parent(".page-item"),page_div=that.parents(".page"),page_items=page_div.find(".page-item");page_item.remove();page_div.find(".page-item").each(function(k,v){$(this).find("span a").text("引导第"+ ++k+"页")});compClass.pageDel(page_type,page_id);$("#comp-main").empty();$("#comp-set").empty();$("#entity-checkbox").hide()});$(document).on("click",".page-title",function(){var that=$(this),page_type=that.attr("data-page-type"),pageId=that.attr("data-page-id");compClass.setPageDoing(pageId);compClass.apiPageComponentList(page_type,pageId);$("#comp-main").empty();$("#comp-set").empty();var pageEntitys=compClass.editPageEntityList(pageId,true);$("#page-doing").text("当前正在操作："+that.text());$("#entity-checkbox").hide();$("#page_wrap .page-active").removeClass("page-active");if(/[13]/.test(page_type.toString())){that.parents(".page-item").addClass("page-active")}else{that.parents(".page-type").addClass("page-active")}});function bindUnload(){if(window.hasEdit==1&&location.pathname.indexOf("test.html")==-1){$(window).bind("beforeunload",function(){return"您输入的内容尚未保存，确定离开此页面吗？"})}}$(".btn-save").click(function(){$(window).unbind("beforeunload");compClass.apiSave()});var awifiUtils={alert_tips:function(id,content){var htm='<div class="awifi_alert awifi_alert_warn">'+'<span class="awifi_alert_message">'+content+"</span>"+'<a class="awifi_alert_close-icon"><i class="icon_cross"></i></a></div>';$("#"+id).append(htm);setTimeout(function(){$("#"+id).find(".awifi_alert").remove()},2500)},verify_field:function(id,reg,reg_empty_msg,reg_fault_msg,default_value,default_value_msg){reg=reg||/^\S+$/gm;reg_empty_msg=reg_empty_msg||"字段不能为空";reg_fault_msg=reg_fault_msg||"字段不合法";default_value=default_value||"";default_value_msg=default_value_msg||"请修改内容";var id_val=$.trim($("#"+id).val());if(id_val.length==0){this.alert_tips("comp-setting",reg_empty_msg);return true}if(default_value&&id_val==default_value){this.alert_tips("comp-setting",default_value_msg);return true}if(!reg.test(id_val)){this.alert_tips("comp-setting",reg_fault_msg);return true}return false}};function previewOpen(){compClass.layerCreate("hidden");function createReactEntityPreview(data){var componentId=data.componentId;var compJson=compClass.getComponentJsonItem(data.componentId),comp_id=data.comp_id;var htm='<li data-id="'+componentId+'" data-code="'+compJson.code+'" data-set-code="'+compJson.setCode+'" data-cid="'+comp_id+'2" style="min-height:auto;">'+'<div id="'+comp_id+'2"></div>'+'<script type="text/javascript">var '+comp_id+"2 = "+compJson.code+"("+JSON.stringify(data.json)+', "'+comp_id+'2").render();</script></li>';_console.log("创建ReactJS createReactEntity=>",htm);$("#comp-main-preview").append(htm)}var pageId=compClass.getPageDoing();var entitys=compClass.getPageEntityData(pageId,true);for(var i=0,len=entitys.length;i<len;i++){var item=entitys[i];if(item.componentOperation!="remove"){createReactEntityPreview(item)}}$("#comp-main-wrap-preview").fadeIn();$("#comp-preview-open").fadeOut()}function previewClose(){$("#comp-main-preview").html("");$("#comp-main-wrap-preview").fadeOut();$("#comp-preview-open").fadeIn();compClass.layerRemove()}